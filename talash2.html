<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø¨Ø§Ø²ÛŒ Ø¢Ù…ÙˆØ²Ø´ ØªÙ„ÙØ¸ (Ú©ÙˆØ¯Ú©)</title>
<style>
  body { font-family: Tahoma, 'Vazir', sans-serif; direction: rtl; text-align: center; padding: 18px; background: #fffbe6; color:#222;}
  h1 { font-size: 24px; margin: 14px 0; }
  #card { background: #ffffff; border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,0.08); padding: 18px; max-width: 560px; margin: auto; }
  #big { font-size: 110px; margin: 12px 0; }
  button { font-size: 18px; padding: 10px 14px; margin: 8px; border-radius: 10px; border: none; cursor: pointer; background:#4CAF50; color:white; }
  .muted { background:#ddd; color:#333; }
  #message { font-size:18px; margin-top:12px; min-height:28px; }
  .choices { display:flex; justify-content:center; gap:10px; flex-wrap:wrap; margin-top:12px; }
  .choice-btn { padding:10px 14px; border-radius:10px; border:2px solid #4a4a4a; background:#fff; cursor:pointer; font-size:18px; min-width:110px; }
  .correct { background: #c8e6c9; border-color:#219653; }
  .wrong { background: #ffcdd2; border-color:#c62828; }
  #stars { font-size:20px; margin-top:8px; color:#f39c12; min-height:22px;}
  small { color:#555; display:block; margin-top:10px;}
</style>
</head>
<body>
  <div id="card">
    <h1>Ø¨Ø§Ø²ÛŒ ØªÙ„ÙØ¸ Ùˆ Ø®ÙˆØ§Ù†Ø¯Ù† â€” Ù…Ø®ØµÙˆØµ Ú©ÙˆØ¯Ú©Ø§Ù†</h1>

    <div id="stageTitle">Ù…Ø±Ø­Ù„Ù‡ Û±: ØªÙ„ÙØ¸ ÛŒÚ© Ø­Ø±Ù</div>

    <div id="big">Ø¨</div>

    <div>
      <button id="playBtn">ğŸ”Š Ù¾Ø®Ø´</button>
      <button id="listenBtn">ğŸ¤ Ú¯ÙˆØ´ Ú©Ù† (ØªÙ„ÙØ¸ Ú©Ù†)</button>
      <button id="skipBtn" class="muted">â­ï¸ Ø¨Ø¹Ø¯ÛŒ</button>
    </div>

    <div id="message"></div>
    <div id="stars"></div>

    <div id="combineArea" style="display:none; margin-top: 18px;">
      <h2>Ù…Ø±Ø­Ù„Ù‡ Û²: ØªØ±Ú©ÛŒØ¨ Ø­Ø±ÙˆÙ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ú©Ù„Ù…Ù‡</h2>
      <div id="combineLetters" style="font-size:50px; margin:12px 0;"></div>
      <div>
        <button id="playWordBtn">ğŸ”Š Ù¾Ø®Ø´ Ú©Ù„Ù…Ù‡</button>
        <button id="listenWordBtn">ğŸ¤ ØªÙ„ÙØ¸ Ú©Ù†</button>
      </div>
      <div id="combineMessage"></div>
    </div>

    <div id="chooseArea" style="display:none; margin-top: 18px;">
      <h2>Ù…Ø±Ø­Ù„Ù‡ Û³: Ú©Ù„Ù…Ù‡ Ø¯Ø±Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†</h2>
      <button id="playTargetWord" class="muted">ğŸ”Š Ù¾Ø®Ø´ Ú©Ù„Ù…Ù‡ Ù‡Ø¯Ù</button>
      <div class="choices" id="choices"></div>
      <div id="chooseMessage"></div>
    </div>

    <small>ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ Ø¹Ù…Ù„Ú©Ø±Ø¯ Ø¨Ù‡ØªØ±ØŒ Ø§Ø² Ù…Ø±ÙˆØ±Ú¯Ø± Ú©Ø±ÙˆÙ… Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù† Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ Ø¨Ø¯Ù‡.</small>
  </div>

<script>
/* ========= Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ (Ù‚Ø§Ø¨Ù„ Ú¯Ø³ØªØ±Ø´) ========= */
const lessons = [
  // Ù‡Ø± Ø¯Ø±Ø³: Ø­Ø±ÙØŒ ØªØ±Ú©ÛŒØ¨ (Ø¢Ø±Ø§ÛŒÙ‡ Ø­Ø±ÙˆÙ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡ 2)ØŒ Ú©Ù„Ù…Ù‡Ù” Ú©Ø§Ù…Ù„ØŒ Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù…Ø±Ø­Ù„Ù‡ 3 (ÛŒÚ©ÛŒ Ø§Ø² Ø¢Ù†Ù‡Ø§ Ú©Ù„Ù…Ù‡Ù” Ø¯Ø±Ø³Øª)
  { letter: "Ø¨", combo: ["Ø¨","Ø§"], word: "Ø¨Ø§", choices: ["Ø¨Ø§","Ø¨ÛŒ","Ø¨Ùˆ"] },
  { letter: "Ù…", combo: ["Ù…","Ø§"], word: "Ù…Ø§", choices: ["Ù…Ø§","Ù…ÛŒ","Ù…Ùˆ"] },
  { letter: "Ø¯", combo: ["Ø¯","Ø§"], word: "Ø¯Ø§", choices: ["Ø¯Ø§","Ø¯ÛŒ","Ø¯Ùˆ"] },
  { letter: "Ø³", combo: ["Ø³","Ø§"], word: "Ø³Ø§", choices: ["Ø³Ø§","Ø³ÛŒ","Ø³Ùˆ"] }
];
let lessonIndex = 0;
let stars = 0;

/* ========= Ù†Ù…Ø§ÛŒØ´ Ø§ÙˆÙ„ÛŒÙ‡ ========= */
const big = document.getElementById('big');
const stageTitle = document.getElementById('stageTitle');
const playBtn = document.getElementById('playBtn');
const listenBtn = document.getElementById('listenBtn');
const skipBtn = document.getElementById('skipBtn');
const message = document.getElementById('message');
const starsEl = document.getElementById('stars');

const combineArea = document.getElementById('combineArea');
const combineLetters = document.getElementById('combineLetters');
const playWordBtn = document.getElementById('playWordBtn');
const listenWordBtn = document.getElementById('listenWordBtn');
const combineMessage = document.getElementById('combineMessage');

const chooseArea = document.getElementById('chooseArea');
const playTargetWord = document.getElementById('playTargetWord');
const choicesEl = document.getElementById('choices');
const chooseMessage = document.getElementById('chooseMessage');

function loadLesson(i) {
  const L = lessons[i];
  big.textContent = L.letter;
  stageTitle.textContent = "Ù…Ø±Ø­Ù„Ù‡ Û±: ØªÙ„ÙØ¸ ÛŒÚ© Ø­Ø±Ù";
  message.textContent = "";
  combineArea.style.display = "none";
  chooseArea.style.display = "none";
  updateStars();
}
function updateStars(){ starsEl.textContent = "â­".repeat(stars); }

/* ========= ØªØ¨Ø¯ÛŒÙ„ Ùˆ Ù†Ø±Ù…Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù…ØªÙ† Ø¨Ø±Ø§ÛŒ Ù…Ù‚Ø§ÛŒØ³Ù‡Ù” Ú¯ÙØªØ§Ø±ÛŒ ========= */
function normalizePersian(s) {
  if(!s) return "";
  s = s.toLowerCase().trim();
  // Ø­Ø°Ù Ø§Ø¹Ø±Ø§Ø¨ Ùˆ ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¶Ø§ÙÛŒ
  s = s.replace(/[\u064B-\u0652]/g, ""); // diacritics
  s = s.replace(/[ÙŠ]/g, "ÛŒ").replace(/[Ùƒ]/g, "Ú©");
  s = s.replace(/Ø¢/g, "Ø§"); // Ù‡Ù…Ø³Ø§Ù†â€ŒØ³Ø§Ø²ÛŒ Ø³Ø§Ø¯Ù‡
  s = s.replace(/\s+/g, "");
  return s;
}

/* ========= Text-to-Speech Ø³Ø§Ø¯Ù‡ ========= */
function speak(text, onend) {
  if (!("speechSynthesis" in window)) {
    alert("Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù¾Ø®Ø´ Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.");
    if (onend) onend();
    return;
  }
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'fa-IR';
  u.rate = 0.9;
  u.onend = onend;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ========= Speech Recognition ========= */
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition || null;
function isRecognitionAvailable(){ return !!SpeechRecognition; }

function listenOnce(lang='fa-IR', onResult, onError) {
  if (!SpeechRecognition) {
    if(onError) onError("noapi");
    return;
  }
  const r = new SpeechRecognition();
  r.lang = lang;
  r.interimResults = false;
  r.maxAlternatives = 3;
  try {
    r.start();
  } catch(e) {
    if(onError) onError(e.message || e);
    return;
  }
  r.onresult = function(ev) {
    const transcript = ev.results[0][0].transcript;
    onResult && onResult(transcript);
  };
  r.onerror = function(ev) {
    onError && onError(ev.error || ev.message || 'error');
  };
  // timeout safety: stop after 6s
  setTimeout(()=>{ try{ r.stop(); }catch(e){} }, 7000);
}

/* ========= Ù…Ø±Ø­Ù„Ù‡ 1: Ø­Ø±Ù ========= */
playBtn.addEventListener('click', ()=> {
  const L = lessons[lessonIndex];
  speak(L.letter);
});
listenBtn.addEventListener('click', ()=> {
  if(!isRecognitionAvailable()){ message.textContent = "ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ ÙØ¹Ø§Ù„ Ù†ÛŒØ³Øª."; return; }
  message.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ú©Ø±Ø¯Ù†... Ù„Ø·ÙØ§Ù‹ Ø­Ø±Ù Ø±Ø§ Ø¨Ø§ ØµØ¯Ø§ÛŒ Ø¨Ù„Ù†Ø¯ Ø¨Ú¯Ùˆ.";
  listenOnce('fa-IR', (transcript)=>{
    message.textContent = "Ø´Ù…Ø§ Ú¯ÙØªÛŒØ¯: " + transcript;
    const got = normalizePersian(transcript);
    const target = normalizePersian(lessons[lessonIndex].letter);
    if(got === target || got.includes(target)) {
      message.textContent = "Ø¢ÙØ±ÛŒÙ†! ØªÙ„ÙØ¸ Ø­Ø±Ù Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯ ğŸ‰";
      stars += 1;
      updateStars();
      // Ø¨Ø±Ùˆ Ù…Ø±Ø­Ù„Ù‡ ØªØ±Ú©ÛŒØ¨ Ø¨Ø¹Ø¯ Ø§Ø² Ø¯Ùˆ Ø«Ø§Ù†ÛŒÙ‡
      setTimeout(()=> startCombineStage(), 900);
    } else {
      message.textContent = "Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨ â€” Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†. (ÛŒØ§ Ø¯Ú©Ù…Ù‡ Ù¾Ø®Ø´ Ø±Ø§ Ø¨Ø²Ù† ØªØ§ ØµØ¯Ø§ Ø±Ø§ Ú¯ÙˆØ´ Ú©Ù†ÛŒ)";
    }
  }, (err)=>{
    if(err === "noapi") message.textContent = "Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
    else message.textContent = "Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø±: " + err;
  });
});

/* ========= Ù…Ø±Ø­Ù„Ù‡ Û²: ØªØ±Ú©ÛŒØ¨ Ø­Ø±ÙˆÙ ========= */
function startCombineStage(){
  const L = lessons[lessonIndex];
  stageTitle.textContent = "Ù…Ø±Ø­Ù„Ù‡ Û²: ØªØ±Ú©ÛŒØ¨ Ø­Ø±ÙˆÙ";
  combineArea.style.display = "block";
  combineLetters.textContent = L.combo.join(" + ");
  combineMessage.textContent = "";
  // Ø®ÙˆØ¯Ú©Ø§Ø± Ù¾Ø®Ø´ Ú©Ù†
  speak(L.word);
}
playWordBtn.addEventListener('click', ()=>{
  speak(lessons[lessonIndex].word);
});
listenWordBtn.addEventListener('click', ()=>{
  if(!isRecognitionAvailable()){ combineMessage.textContent = "ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯."; return; }
  combineMessage.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ú¯ÙˆØ´ Ú©Ø±Ø¯Ù†... Ù„Ø·ÙØ§Ù‹ Ú©Ù„Ù…Ù‡ Ø±Ø§ Ø¨Ú¯Ùˆ.";
  listenOnce('fa-IR', (transcript)=>{
    combineMessage.textContent = "Ø´Ù…Ø§ Ú¯ÙØªÛŒØ¯: " + transcript;
    const got = normalizePersian(transcript);
    const target = normalizePersian(lessons[lessonIndex].word);
    if(got === target || got.includes(target)) {
      combineMessage.textContent = "Ø¢ÙØ±ÛŒÙ†! ØªÙ„ÙØ¸ Ú©Ù„Ù…Ù‡ Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯ ğŸ‰";
      stars += 1;
      updateStars();
      setTimeout(()=> startChooseStage(), 900);
    } else {
      combineMessage.textContent = "Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù† ÛŒØ§ ØµØ¯Ø§ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ú¯ÙˆØ´ Ú©Ù†.";
    }
  }, (err)=> {
    combineMessage.textContent = "Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ: " + err;
  });
});

/* ========= Ù…Ø±Ø­Ù„Ù‡ Û³: Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø² Ø¨ÛŒÙ† Ø³Ù‡ Ú©Ù„Ù…Ù‡ ========= */
function startChooseStage(){
  stageTitle.textContent = "Ù…Ø±Ø­Ù„Ù‡ Û³: Ú©Ù„Ù…Ù‡Ù” Ø¯Ø±Ø³Øª Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†";
  chooseArea.style.display = "block";
  chooseMessage.textContent = "";
  // Ù¾Ø± Ú©Ø±Ø¯Ù† Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§
  const L = lessons[lessonIndex];
  choicesEl.innerHTML = "";
  // shuffle choices for variety
  const opts = shuffleArray(L.choices.slice());
  opts.forEach(opt=>{
    const btn = document.createElement('button');
    btn.className = 'choice-btn';
    btn.textContent = opt;
    btn.addEventListener('click', ()=> {
      const got = normalizePersian(opt);
      const target = normalizePersian(L.word);
      if(got === target){
        btn.classList.add('correct');
        chooseMessage.textContent = "Ø¯Ø±Ø³Øª Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø±Ø¯ÛŒ! Ø¢ÙØ±ÛŒÙ† ğŸ‰";
        stars += 1;
        updateStars();
        // Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ
        setTimeout(()=> nextLesson(), 1200);
      } else {
        btn.classList.add('wrong');
        chooseMessage.textContent = "Ù†Ù‡ØŒ Ø§ÛŒÙ† Ø¯Ø±Ø³Øª Ù†Ø¨ÙˆØ¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†.";
      }
    });
    choicesEl.appendChild(btn);
  });
  // Ø¯Ú©Ù…Ù‡ Ù¾Ø®Ø´ Ù‡Ø¯Ù
  playTargetWord.onclick = ()=> speak(L.word);
  // Ù¾Ø®Ø´ Ù‡Ø¯Ù Ø®ÙˆØ¯Ú©Ø§Ø±
  speak(L.word);
}

/* ========= Ø¯Ø±Ø³ Ø¨Ø¹Ø¯ÛŒ ========= */
function nextLesson(){
  lessonIndex++;
  if(lessonIndex >= lessons.length){
    // Ù¾Ø§ÛŒØ§Ù† ØªÙ…Ø±ÛŒÙ†
    stageTitle.textContent = "ØªØ¨Ø±ÛŒÚ©! ØªÙ…Ø±ÛŒÙ† ØªÙ…Ø§Ù… Ø´Ø¯";
    big.textContent = "ØªÙ…Ø§Ù… Ø´Ø¯ ğŸ‰";
    combineArea.style.display = "none";
    chooseArea.style.display = "none";
    message.textContent = `Ø´Ù…Ø§ ${stars} Ø³ØªØ§Ø±Ù‡ Ø¨Ù‡â€ŒØ¯Ø³Øª Ø¢ÙˆØ±Ø¯ÛŒØ¯. Ø¢ÙØ±ÛŒÙ†!`;
    playBtn.disabled = true;
    listenBtn.disabled = true;
    skipBtn.disabled = true;
    return;
  }
  // Ø±ÛŒØ³Øª Ùˆ Ù„ÙˆØ¯ Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯
  combineArea.style.display = "none";
  chooseArea.style.display = "none";
  loadLesson(lessonIndex);
  // Ù¾Ø®Ø´ Ø­Ø±Ù Ø¬Ø¯ÛŒØ¯
  setTimeout(()=> speak(lessons[lessonIndex].letter), 500);
}

/* ========= Ø¯Ú©Ù…Ù‡ Ø¨Ø¹Ø¯ÛŒ/Ø±Ø¯ Ø´Ø¯Ù† Ø¨Ø±Ø§ÛŒ ØªØ³Øª ========= */
skipBtn.addEventListener('click', ()=> {
  nextLesson();
});

/* ========= Ø´Ø§Ù†Ø³/Ø§Ø¨Ø²Ø§Ø± Ú©Ù…Ú©ÛŒ: Ø§Ú¯Ø± ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ ========= */
if(!isRecognitionAvailable()){
  message.textContent = "ØªÙˆØ¬Ù‡: Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² ØªØ´Ø®ÛŒØµ Ú¯ÙØªØ§Ø± Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¨Ø§ Ø¯Ú©Ù…Ù‡Ù” Ù¾Ø®Ø´ØŒ ØµØ¯Ø§ Ø±Ø§ Ú¯ÙˆØ´ Ú©Ù†ÛŒØ¯ Ùˆ Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø³ØªÛŒ ØªÙ…Ø±ÛŒÙ† Ú©Ù†ÛŒØ¯.";
}

/* ========= Ø§Ø¨Ø²Ø§Ø± Ú©Ù…Ú©: shuffle ========= */
function shuffleArray(a){
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* ========= Ø´Ø±ÙˆØ¹ ========= */
loadLesson(lessonIndex);
</script>
</body>
</html>